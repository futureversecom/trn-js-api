2bc608c5cb4c0d035bdbac41e2d71eba
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GAS_TOKEN_ID = exports.BOB_PRIVATE_KEY = exports.ALITH_PRIVATE_KEY = void 0;
const api_1 = require("@polkadot/api");
const api_2 = require("@therootnetwork/api");
const util_1 = require("@polkadot/util");
exports.ALITH_PRIVATE_KEY = "0x5fb92d6e98884f76de468fa3f6278f8807c48bebc13595d45af5bdc4da702133";
exports.BOB_PRIVATE_KEY = "0x79c3b7fc0b7697b9414cb87adcb37317d1cab32818ae18c0e97ad76395d1fdcf";
const TOKEN_ID = 1124;
exports.GAS_TOKEN_ID = 2;
let collectionOwner, tokenOwner;
let globalCollectionId;
let globalTokenIds;
describe('DEX RPC calls testing', () => {
    let api;
    let alith, bob;
    beforeAll(async () => {
        const providerUrl = 'ws://127.0.0.1:9944/';
        const provider = new api_1.WsProvider(providerUrl);
        api = new api_1.ApiPromise((0, api_2.options)({ provider }));
        await api.isReady;
        const keyring = new api_1.Keyring({ type: "ethereum" });
        alith = keyring.addFromSeed((0, util_1.hexToU8a)(exports.ALITH_PRIVATE_KEY));
        bob = keyring.addFromSeed((0, util_1.hexToU8a)(exports.BOB_PRIVATE_KEY));
        collectionOwner = alith;
    });
    afterAll(async () => {
        api.disconnect();
    });
    describe('NFTs', () => {
        let collectionId;
        beforeEach(async () => {
            // Create collection and series for each test to use
            const collectionName = 'global-example-collection';
            const quantity = 3;
            const maxIssuance = null;
            const tokenOwner = null;
            const royalty = null;
            const crossChainCompatibility = { "xrpl": false };
            globalTokenIds = [...Array(quantity)];
            const metadataSchema = "http://example.com/nft/metadata";
            await api.tx.nft.createCollection(collectionName, quantity, maxIssuance, tokenOwner, metadataSchema, royalty, crossChainCompatibility).signAndSend(collectionOwner, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ event: { data, method } }) => {
                        if (method == 'CreateCollection') {
                            globalCollectionId = data[0].toNumber();
                        }
                    });
                    await api.tx.nft.mint(globalCollectionId, quantity, tokenOwner.address)
                        .signAndSend(collectionOwner, { nonce: -1 }, async ({ status, events }) => {
                        if (status.isInBlock) {
                            events.forEach(({ event: { data, method } }) => {
                                if (method == 'Mint') {
                                    const collectionId = data[0].toNumber();
                                    let seriesId = data[1].toNumber();
                                    globalTokenIds = globalTokenIds.map((_, serialNumber) => [collectionId, seriesId, serialNumber]);
                                }
                            });
                        }
                    });
                }
            });
        });
        it('creates a collection', async () => {
            const collectionName = 'example-collection';
            const quantity = 3;
            const maxIssuance = null;
            const tokenOwner = null;
            const royalty = null;
            const crossChainCompatibility = { "xrpl": false };
            const metadataSchema = "http://example.com/nft/metadata";
            await api.tx.nft.createCollection(collectionName, quantity, maxIssuance, tokenOwner, metadataSchema, royalty, crossChainCompatibility).signAndSend(collectionOwner, { nonce: -1 }, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ phase, event: { data, method, section } }) => {
                        console.log('\t', phase.toString(), `: ${section}.${method}`, data.toString());
                        if (method == 'CreateCollection') {
                            collectionId = data[0].toNumber();
                            console.log(`got collection: ${collectionId}`);
                        }
                    });
                    const info = await api.query.nft.collectionInfo(collectionId);
                    expect(info.owner).toBe(collectionOwner.address);
                    expect(info.name).toBe((0, util_1.stringToHex)(collectionName));
                }
            });
        });
        it('burn second token from series', async () => {
            const serialNumber = 1;
            const tokenId = [1124, serialNumber];
            console.log('api.tx.nft::', api.tx.nft);
            console.log('api.tx.nft.burn::', api.tx.nft.burn);
            await api.tx.nft.burn(tokenId)
                .signAndSend(collectionOwner, { nonce: -1 }, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ event: { data, method } }) => {
                        if (method == 'Burn') {
                            const [collId, serialNo] = data;
                            expect(collId.toNumber()).toEqual(globalCollectionId);
                            expect(serialNo.toNumber()).toEqual(serialNumber);
                        }
                    });
                }
            });
        });
        it('finds collected tokens', async () => {
            const cursor = 0;
            const limit = 5;
            const ownedTokens = (await api.rpc.nft.ownedTokens(globalCollectionId, collectionOwner.address, cursor, limit));
            expect(ownedTokens[2]).toEqual([0, 1, 2]);
        });
    });
    /// TODO - add more test for listing buy/sell
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2thcmlzaG1hL3dvcmsvZnV0dXJldmVyc2UvdHJuLXJvb3RuZXQtYXBpL3BhY2thZ2VzL2FwaS90ZXN0L2UyZS9uZnQuZTJlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUE4RDtBQUM5RCw2Q0FBNEM7QUFDNUMseUNBQXFEO0FBRXhDLFFBQUEsaUJBQWlCLEdBQUcsb0VBQW9FLENBQUM7QUFDekYsUUFBQSxlQUFlLEdBQUcsb0VBQW9FLENBQUM7QUFDcEcsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ1QsUUFBQSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLElBQUksZUFBZSxFQUFFLFVBQVUsQ0FBQztBQUNoQyxJQUFJLGtCQUFrQixDQUFDO0FBQ3ZCLElBQUksY0FBYyxDQUFDO0FBRW5CLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxHQUFHLENBQUM7SUFDUixJQUFJLEtBQUssRUFBRSxHQUFHLENBQUM7SUFDZixTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDakIsTUFBTSxXQUFXLEdBQUcsc0JBQXNCLENBQUM7UUFDM0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxnQkFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLEdBQUcsR0FBRyxJQUFJLGdCQUFVLENBQUMsSUFBQSxhQUFPLEVBQUMsRUFBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUMsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLElBQUksYUFBTyxDQUFDLEVBQUMsSUFBSSxFQUFFLFVBQVUsRUFBQyxDQUFDLENBQUM7UUFDaEQsS0FBSyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBQSxlQUFRLEVBQUMseUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3pELEdBQUcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUEsZUFBUSxFQUFDLHVCQUFlLENBQUMsQ0FBQyxDQUFDO1FBQ3JELGVBQWUsR0FBRyxLQUFLLENB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Q0FBQzs0QkFDdEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQzt5QkFDbkQ7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHdCQUF3QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3JDLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQztZQUNqQixNQUFNLEtBQUssR0FBRyxDQUFDLENBQUM7WUFDakIsTUFBTSxXQUFXLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsRUFBRSxlQUFlLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2pILE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVDLDZDQUE2QztBQUNqRCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2FyaXNobWEvd29yay9mdXR1cmV2ZXJzZS90cm4tcm9vdG5ldC1hcGkvcGFja2FnZXMvYXBpL3Rlc3QvZTJlL25mdC5lMmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBcGlQcm9taXNlLCBLZXlyaW5nLCBXc1Byb3ZpZGVyfSBmcm9tIFwiQHBvbGthZG90L2FwaVwiO1xuaW1wb3J0IHtvcHRpb25zfSBmcm9tIFwiQHRoZXJvb3RuZXR3b3JrL2FwaVwiO1xuaW1wb3J0IHtoZXhUb1U4YSwgc3RyaW5nVG9IZXh9IGZyb20gXCJAcG9sa2Fkb3QvdXRpbFwiO1xuXG5leHBvcnQgY29uc3QgQUxJVEhfUFJJVkFURV9LRVkgPSBcIjB4NWZiOTJkNmU5ODg4NGY3NmRlNDY4ZmEzZjYyNzhmODgwN2M0OGJlYmMxMzU5NWQ0NWFmNWJkYzRkYTcwMjEzM1wiO1xuZXhwb3J0IGNvbnN0IEJPQl9QUklWQVRFX0tFWSA9IFwiMHg3OWMzYjdmYzBiNzY5N2I5NDE0Y2I4N2FkY2IzNzMxN2QxY2FiMzI4MThhZTE4YzBlOTdhZDc2Mzk1ZDFmZGNmXCI7XG5jb25zdCBUT0tFTl9JRCA9IDExMjQ7XG5leHBvcnQgY29uc3QgR0FTX1RPS0VOX0lEID0gMjtcbmxldCBjb2xsZWN0aW9uT3duZXIsIHRva2VuT3duZXI7XG5sZXQgZ2xvYmFsQ29sbGVjdGlvbklkO1xubGV0IGdsb2JhbFRva2VuSWRzO1xuXG5kZXNjcmliZSgnREVYIFJQQyBjYWxscyB0ZXN0aW5nJywgKCkgPT4ge1xuICAgIGxldCBhcGk7XG4gICAgbGV0IGFsaXRoLCBib2I7XG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJVcmwgPSAnd3M6Ly8xMjcuMC4wLjE6OTk0NC8nO1xuICAgICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBXc1Byb3ZpZGVyKHByb3ZpZGVyVXJsKTtcbiAgICAgICAgYXBpID0gbmV3IEFwaVByb21pc2Uob3B0aW9ucyh7cHJvdmlkZXJ9KSk7XG4gICAgICAgIGF3YWl0IGFwaS5pc1JlYWR5O1xuICAgICAgICBjb25zdCBrZXlyaW5nID0gbmV3IEtleXJpbmcoe3R5cGU6IFwiZXRoZXJldW1cIn0pO1xuICAgICAgICBhbGl0aCA9IGtleXJpbmcuYWRkRnJvbVNlZWQoaGV4VG9VOGEoQUxJVEhfUFJJVkFURV9LRVkpKTtcbiAgICAgICAgYm9iID0ga2V5cmluZy5hZGRGcm9tU2VlZChoZXhUb1U4YShCT0JfUFJJVkFURV9LRVkpKTtcbiAgICAgICAgY29sbGVjdGlvbk93bmVyID0gYWxpdGg7XG4gICAgfSk7XG5cbiAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAgIGFwaS5kaXNjb25uZWN0KCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnTkZUcycsICgpID0+IHtcbiAgICAgICAgbGV0IGNvbGxlY3Rpb25JZDogbnVtYmVyO1xuXG4gICAgICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGNvbGxlY3Rpb24gYW5kIHNlcmllcyBmb3IgZWFjaCB0ZXN0IHRvIHVzZVxuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWUgPSAnZ2xvYmFsLWV4YW1wbGUtY29sbGVjdGlvbic7XG4gICAgICAgICAgICBjb25zdCBxdWFudGl0eSA9IDM7XG4gICAgICAgICAgICBjb25zdCBtYXhJc3N1YW5jZSA9IG51bGw7XG4gICAgICAgICAgICBjb25zdCB0b2tlbk93bmVyID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnN0IHJveWFsdHkgPSBudWxsO1xuICAgICAgICAgICAgY29uc3QgY3Jvc3NDaGFpbkNvbXBhdGliaWxpdHkgPSB7XCJ4cnBsXCI6IGZhbHNlfTtcbiAgICAgICAgICAgIGdsb2JhbFRva2VuSWRzID0gWy4uLkFycmF5KHF1YW50aXR5KV1cbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhU2NoZW1hID0gXCJodHRwOi8vZXhhbXBsZS5jb20vbmZ0L21ldGFkYXRhXCI7XG4gICAgICAgICAgICBhd2FpdCBhcGkudHgubmZ0LmNyZWF0ZUNvbGxlY3Rpb24oXG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbk5hbWUsIHF1YW50aXR5LFxuICAgICAgICAgICAgICAgIG1heElzc3VhbmNlLCB0b2tlbk93bmVyLCBtZXRhZGF0YVNjaGVtYSwgcm95YWx0eSwgY3Jvc3NDaGFpbkNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgICkuc2lnbkFuZFNlbmQoY29sbGVjdGlvbk93bmVyLCBhc3luYyAoe3N0YXR1cywgZXZlbnRzfSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMuaXNJbkJsb2NrKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCh7ZXZlbnQ6IHtkYXRhLCBtZXRob2R9fSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PSAnQ3JlYXRlQ29sbGVjdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxDb2xsZWN0aW9uSWQgPSBkYXRhWzBdLnRvTnVtYmVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFwaS50eC5uZnQubWludChnbG9iYWxDb2xsZWN0aW9uSWQsIHF1YW50aXR5LCB0b2tlbk93bmVyLmFkZHJlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2lnbkFuZFNlbmQoY29sbGVjdGlvbk93bmVyLCB7bm9uY2U6IC0xfSwgYXN5bmMgKHtzdGF0dXMsIGV2ZW50c30pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzLmlzSW5CbG9jaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHMuZm9yRWFjaCgoe2V2ZW50OiB7ZGF0YSwgbWV0aG9kfX0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT0gJ01pbnQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbklkID0gZGF0YVswXS50b051bWJlcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNlcmllc0lkID0gZGF0YVsxXS50b051bWJlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbFRva2VuSWRzID0gZ2xvYmFsVG9rZW5JZHMubWFwKChfLCBzZXJpYWxOdW1iZXIpID0+IFtjb2xsZWN0aW9uSWQsIHNlcmllc0lkLCBzZXJpYWxOdW1iZXJdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgICBpdCgnY3JlYXRlcyBhIGNvbGxlY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb25OYW1lID0gJ2V4YW1wbGUtY29sbGVjdGlvbic7XG4gICAgICAgICAgICAgIGNvbnN0IHF1YW50aXR5ID0gMztcbiAgICAgICAgICAgICAgY29uc3QgbWF4SXNzdWFuY2UgPSBudWxsO1xuICAgICAgICAgICAgICBjb25zdCB0b2tlbk93bmVyID0gbnVsbDtcbiAgICAgICAgICAgICAgY29uc3Qgcm95YWx0eSA9IG51bGw7XG4gICAgICAgICAgICAgIGNvbnN0IGNyb3NzQ2hhaW5Db21wYXRpYmlsaXR5ID0ge1wieHJwbFwiOiBmYWxzZX07XG4gICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhU2NoZW1hID0gXCJodHRwOi8vZXhhbXBsZS5jb20vbmZ0L21ldGFkYXRhXCI7XG4gICAgICAgICAgICBhd2FpdCBhcGkudHgubmZ0LmNyZWF0ZUNvbGxlY3Rpb24oXG4gICAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lLCBxdWFudGl0eSxcbiAgICAgICAgICAgICAgICBtYXhJc3N1YW5jZSwgdG9rZW5Pd25lciwgbWV0YWRhdGFTY2hlbWEsIHJveWFsdHksIGNyb3NzQ2hhaW5Db21wYXRpYmlsaXR5XG4gICAgICAgICAgICApLnNpZ25BbmRTZW5kKGNvbGxlY3Rpb25Pd25lciwge25vbmNlOiAtMX0sYXN5bmMgKHsgc3RhdHVzLCBldmVudHMgfSkgPT4ge1xuICAgICAgICAgICAgICBpZiAoc3RhdHVzLmlzSW5CbG9jaykge1xuICAgICAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCh7cGhhc2UsIGV2ZW50OiB7ZGF0YSwgbWV0aG9kLCBzZWN0aW9ufX0pID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXHQnLCBwaGFzZS50b1N0cmluZygpLCBgOiAke3NlY3Rpb259LiR7bWV0aG9kfWAsIGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgICBpZiAobWV0aG9kID09ICdDcmVhdGVDb2xsZWN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uSWQgPSBkYXRhWzBdLnRvTnVtYmVyKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBnb3QgY29sbGVjdGlvbjogJHtjb2xsZWN0aW9uSWR9YCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IGFwaS5xdWVyeS5uZnQuY29sbGVjdGlvbkluZm8oY29sbGVjdGlvbklkKTtcbiAgICAgICAgICAgICAgICBleHBlY3QoaW5mby5vd25lcikudG9CZShjb2xsZWN0aW9uT3duZXIuYWRkcmVzcyk7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGluZm8ubmFtZSkudG9CZShzdHJpbmdUb0hleChjb2xsZWN0aW9uTmFtZSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcblxuXG5cbiAgaXQoJ2J1cm4gc2Vjb25kIHRva2VuIGZyb20gc2VyaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNlcmlhbE51bWJlciA9IDE7XG4gICAgY29uc3QgdG9rZW5JZCA9IFsxMTI0LCBzZXJpYWxOdW1iZXJdO1xuICAgIGNvbnNvbGUubG9nKCdhcGkudHgubmZ0OjonLGFwaS50eC5uZnQpO1xuICAgIGNvbnNvbGUubG9nKCdhcGkudHgubmZ0LmJ1cm46OicsYXBpLnR4Lm5mdC5idXJuKTtcbiAgICBhd2FpdCBhcGkudHgubmZ0LmJ1cm4odG9rZW5JZClcbiAgICAgIC5zaWduQW5kU2VuZChjb2xsZWN0aW9uT3duZXIsIHtub25jZTogLTF9LCBhc3luYyAoeyBzdGF0dXMsIGV2ZW50cyB9KSA9PiB7XG4gICAgICAgIGlmIChzdGF0dXMuaXNJbkJsb2NrKSB7XG4gICAgICAgICAgZXZlbnRzLmZvckVhY2goKHtldmVudDoge2RhdGEsIG1ldGhvZH19KSA9PiB7XG4gICAgICAgICAgICBpZiAobWV0aG9kID09ICdCdXJuJykge1xuICAgICAgICAgICAgICBjb25zdCBbY29sbElkLCBzZXJpYWxObyBdID0gZGF0YTtcbiAgICAgICAgICAgICAgZXhwZWN0KGNvbGxJZC50b051bWJlcigpKS50b0VxdWFsKGdsb2JhbENvbGxlY3Rpb25JZCk7XG4gICAgICAgICAgICAgIGV4cGVjdChzZXJpYWxOby50b051bWJlcigpKS50b0VxdWFsKHNlcmlhbE51bWJlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9KTtcblxuICBpdCgnZmluZHMgY29sbGVjdGVkIHRva2VucycsIGFzeW5jICgpID0+IHtcbiAgICAgY29uc3QgY3Vyc29yID0gMDtcbiAgICAgY29uc3QgbGltaXQgPSA1O1xuICAgIGNvbnN0IG93bmVkVG9rZW5zID0gKGF3YWl0IGFwaS5ycGMubmZ0Lm93bmVkVG9rZW5zKGdsb2JhbENvbGxlY3Rpb25JZCwgY29sbGVjdGlvbk93bmVyLmFkZHJlc3MsIGN1cnNvciAsIGxpbWl0KSk7XG4gICAgZXhwZWN0KG93bmVkVG9rZW5zWzJdKS50b0VxdWFsKFswLCAxLCAyXSk7XG4gIH0pO1xufSk7XG5cbiAgICAvLy8gVE9ETyAtIGFkZCBtb3JlIHRlc3QgZm9yIGxpc3RpbmcgYnV5L3NlbGxcbn0pO1xuXG4iXSwidmVyc2lvbiI6M30=