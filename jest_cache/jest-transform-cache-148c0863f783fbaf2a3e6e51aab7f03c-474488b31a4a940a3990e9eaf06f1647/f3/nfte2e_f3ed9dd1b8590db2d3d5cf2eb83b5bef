a01482faf467c54ff0c9585685788554
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GAS_TOKEN_ID = exports.BOB_PRIVATE_KEY = exports.ALITH_PRIVATE_KEY = void 0;
const api_1 = require("@polkadot/api");
const api_2 = require("@therootnetwork/api");
const util_1 = require("@polkadot/util");
exports.ALITH_PRIVATE_KEY = "0x5fb92d6e98884f76de468fa3f6278f8807c48bebc13595d45af5bdc4da702133";
exports.BOB_PRIVATE_KEY = "0x79c3b7fc0b7697b9414cb87adcb37317d1cab32818ae18c0e97ad76395d1fdcf";
const TOKEN_ID = 1124;
exports.GAS_TOKEN_ID = 2;
let collectionOwner, tokenOwner;
let spendingAssetId;
let globalCollectionId;
let globalTokenIds;
describe('DEX RPC calls testing', () => {
    let api;
    let alith, bob;
    beforeAll(async () => {
        const providerUrl = 'ws://127.0.0.1:9944/';
        const provider = new api_1.WsProvider(providerUrl);
        api = new api_1.ApiPromise((0, api_2.options)({ provider }));
        await api.isReady;
        const keyring = new api_1.Keyring({ type: "ethereum" });
        alith = keyring.addFromSeed((0, util_1.hexToU8a)(exports.ALITH_PRIVATE_KEY));
        bob = keyring.addFromSeed((0, util_1.hexToU8a)(exports.BOB_PRIVATE_KEY));
        collectionOwner = alith;
    });
    afterAll(async () => {
        api.disconnect();
    });
    describe('NFTs', () => {
        let collectionId;
        beforeEach(async () => {
            // Create collection and series for each test to use
            const collectionName = 'global-example-collection';
            const quantity = 3;
            const maxIssuance = null;
            const tokenOwner = null;
            const royalty = null;
            const crossChainCompatibility = { "xrpl": false };
            globalTokenIds = [...Array(quantity)];
            const metadataSchema = "http://example.com/nft/metadata";
            await api.tx.nft.createCollection(collectionName, quantity, maxIssuance, tokenOwner, metadataSchema, royalty, crossChainCompatibility).signAndSend(collectionOwner, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ event: { data, method } }) => {
                        if (method == 'CreateCollection') {
                            globalCollectionId = data[0].toNumber();
                        }
                    });
                    await api.tx.nft.mint(globalCollectionId, quantity, tokenOwner.address)
                        .signAndSend(collectionOwner, { nonce: -1 }, async ({ status, events }) => {
                        if (status.isInBlock) {
                            events.forEach(({ event: { data, method } }) => {
                                if (method == 'Mint') {
                                    const collectionId = data[0].toNumber();
                                    let seriesId = data[1].toNumber();
                                    globalTokenIds = globalTokenIds.map((_, serialNumber) => [collectionId, seriesId, serialNumber]);
                                }
                            });
                        }
                    });
                }
            });
        });
        it('creates a collection', async () => {
            const collectionName = 'example-collection';
            const quantity = 3;
            const maxIssuance = null;
            const tokenOwner = null;
            const royalty = null;
            const crossChainCompatibility = { "xrpl": false };
            const metadataSchema = "http://example.com/nft/metadata";
            await api.tx.nft.createCollection(collectionName, quantity, maxIssuance, tokenOwner, metadataSchema, royalty, crossChainCompatibility).signAndSend(collectionOwner, { nonce: -1 }, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ phase, event: { data, method, section } }) => {
                        console.log('\t', phase.toString(), `: ${section}.${method}`, data.toString());
                        if (method == 'CreateCollection') {
                            collectionId = data[0].toNumber();
                            console.log(`got collection: ${collectionId}`);
                        }
                    });
                    const info = await api.query.nft.collectionInfo(collectionId);
                    expect(info.owner).toBe(collectionOwner.address);
                    expect(info.name).toBe((0, util_1.stringToHex)(collectionName));
                }
            });
        });
        it('burn second token from series', async () => {
            const serialNumber = 1;
            const tokenId = [globalCollectionId, serialNumber];
            // api.registry.createType('TokenId', tokenId);
            await api.tx.nft.burn(tokenId)
                .signAndSend(tokenOwner, { nonce: -1 }, async ({ status, events }) => {
                if (status.isInBlock) {
                    events.forEach(({ event: { data, method } }) => {
                        if (method == 'Burn') {
                            const [collId, serialNo] = data;
                            expect(collId.toNumber()).toEqual(globalCollectionId);
                            expect(serialNo.toNumber()).toEqual(serialNumber);
                        }
                    });
                }
            });
        });
        it('finds collected tokens', async () => {
            const cursor = 0;
            const limit = 5;
            const ownedTokens = (await api.rpc.nft.ownedTokens(globalCollectionId, collectionOwner.address, cursor, limit));
            expect(ownedTokens[2]).toEqual([0, 1, 2]);
        });
    });
    /// TODO - add more test for listing buy/sell
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2thcmlzaG1hL3dvcmsvZnV0dXJldmVyc2UvdHJuLXJvb3RuZXQtYXBpL3BhY2thZ2VzL2FwaS90ZXN0L2UyZS9uZnQuZTJlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUE4RDtBQUM5RCw2Q0FBNEM7QUFDNUMseUNBQXFEO0FBRXhDLFFBQUEsaUJBQWlCLEdBQUcsb0VBQW9FLENBQUM7QUFDekYsUUFBQSxlQUFlLEdBQUcsb0VBQW9FLENBQUM7QUFDcEcsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ1QsUUFBQSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLElBQUksZUFBZSxFQUFFLFVBQVUsQ0FBQztBQUNoQyxJQUFJLGVBQWUsQ0FBQztBQUNwQixJQUFJLGtCQUFrQixDQUFDO0FBQ3ZCLElBQUksY0FBYyxDQUFDO0FBRW5CLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxHQUFHLENBQUM7SUFDUixJQUFJLEtBQUssRUFBRSxHQUFHLENBQUM7SUFDZixTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDakIsTUFBTSxXQUFXLEdBQUcsc0JBQXNCLENBQUM7UUFDM0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxnQkFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLEdBQUcsR0FBRyxJQUFJLGdCQUFVLENBQUMsSUFBQSxhQUFPLEVBQUMsRUFBQyxRQUFRLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUMsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLElBQUksYUFBTyxDQUFDLEVBQUMsSUFBSSxFQUFFLFVBQVUsRUFBQyxDQUFDLENBQUM7UUFDaEQsS0FBSyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBQSxlQUFRLEVBQUMseUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3pELEdBQUcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUEsZUFBUSxFQUFDLHVCQUFlLENBQUMsQ0FBQyxDQUFDO1FB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QUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQztZQUNqQixNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLGVBQWUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDakgsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUMsNkNBQTZDO0FBQ2pELENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9rYXJpc2htYS93b3JrL2Z1dHVyZXZlcnNlL3Rybi1yb290bmV0LWFwaS9wYWNrYWdlcy9hcGkvdGVzdC9lMmUvbmZ0LmUyZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0FwaVByb21pc2UsIEtleXJpbmcsIFdzUHJvdmlkZXJ9IGZyb20gXCJAcG9sa2Fkb3QvYXBpXCI7XG5pbXBvcnQge29wdGlvbnN9IGZyb20gXCJAdGhlcm9vdG5ldHdvcmsvYXBpXCI7XG5pbXBvcnQge2hleFRvVThhLCBzdHJpbmdUb0hleH0gZnJvbSBcIkBwb2xrYWRvdC91dGlsXCI7XG5cbmV4cG9ydCBjb25zdCBBTElUSF9QUklWQVRFX0tFWSA9IFwiMHg1ZmI5MmQ2ZTk4ODg0Zjc2ZGU0NjhmYTNmNjI3OGY4ODA3YzQ4YmViYzEzNTk1ZDQ1YWY1YmRjNGRhNzAyMTMzXCI7XG5leHBvcnQgY29uc3QgQk9CX1BSSVZBVEVfS0VZID0gXCIweDc5YzNiN2ZjMGI3Njk3Yjk0MTRjYjg3YWRjYjM3MzE3ZDFjYWIzMjgxOGFlMThjMGU5N2FkNzYzOTVkMWZkY2ZcIjtcbmNvbnN0IFRPS0VOX0lEID0gMTEyNDtcbmV4cG9ydCBjb25zdCBHQVNfVE9LRU5fSUQgPSAyO1xubGV0IGNvbGxlY3Rpb25Pd25lciwgdG9rZW5Pd25lcjtcbmxldCBzcGVuZGluZ0Fzc2V0SWQ7XG5sZXQgZ2xvYmFsQ29sbGVjdGlvbklkO1xubGV0IGdsb2JhbFRva2VuSWRzO1xuXG5kZXNjcmliZSgnREVYIFJQQyBjYWxscyB0ZXN0aW5nJywgKCkgPT4ge1xuICAgIGxldCBhcGk7XG4gICAgbGV0IGFsaXRoLCBib2I7XG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJVcmwgPSAnd3M6Ly8xMjcuMC4wLjE6OTk0NC8nO1xuICAgICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBXc1Byb3ZpZGVyKHByb3ZpZGVyVXJsKTtcbiAgICAgICAgYXBpID0gbmV3IEFwaVByb21pc2Uob3B0aW9ucyh7cHJvdmlkZXJ9KSk7XG4gICAgICAgIGF3YWl0IGFwaS5pc1JlYWR5O1xuICAgICAgICBjb25zdCBrZXlyaW5nID0gbmV3IEtleXJpbmcoe3R5cGU6IFwiZXRoZXJldW1cIn0pO1xuICAgICAgICBhbGl0aCA9IGtleXJpbmcuYWRkRnJvbVNlZWQoaGV4VG9VOGEoQUxJVEhfUFJJVkFURV9LRVkpKTtcbiAgICAgICAgYm9iID0ga2V5cmluZy5hZGRGcm9tU2VlZChoZXhUb1U4YShCT0JfUFJJVkFURV9LRVkpKTtcbiAgICAgICAgY29sbGVjdGlvbk93bmVyID0gYWxpdGg7XG4gICAgfSk7XG5cbiAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAgIGFwaS5kaXNjb25uZWN0KCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnTkZUcycsICgpID0+IHtcbiAgICAgICAgbGV0IGNvbGxlY3Rpb25JZDogbnVtYmVyO1xuXG4gICAgICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGNvbGxlY3Rpb24gYW5kIHNlcmllcyBmb3IgZWFjaCB0ZXN0IHRvIHVzZVxuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbk5hbWUgPSAnZ2xvYmFsLWV4YW1wbGUtY29sbGVjdGlvbic7XG4gICAgICAgICAgICBjb25zdCBxdWFudGl0eSA9IDM7XG4gICAgICAgICAgICBjb25zdCBtYXhJc3N1YW5jZSA9IG51bGw7XG4gICAgICAgICAgICBjb25zdCB0b2tlbk93bmVyID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnN0IHJveWFsdHkgPSBudWxsO1xuICAgICAgICAgICAgY29uc3QgY3Jvc3NDaGFpbkNvbXBhdGliaWxpdHkgPSB7XCJ4cnBsXCI6IGZhbHNlfTtcbiAgICAgICAgICAgIGdsb2JhbFRva2VuSWRzID0gWy4uLkFycmF5KHF1YW50aXR5KV1cbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhU2NoZW1hID0gXCJodHRwOi8vZXhhbXBsZS5jb20vbmZ0L21ldGFkYXRhXCI7XG4gICAgICAgICAgICBhd2FpdCBhcGkudHgubmZ0LmNyZWF0ZUNvbGxlY3Rpb24oXG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbk5hbWUsIHF1YW50aXR5LFxuICAgICAgICAgICAgICAgIG1heElzc3VhbmNlLCB0b2tlbk93bmVyLCBtZXRhZGF0YVNjaGVtYSwgcm95YWx0eSwgY3Jvc3NDaGFpbkNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgICkuc2lnbkFuZFNlbmQoY29sbGVjdGlvbk93bmVyLCBhc3luYyAoe3N0YXR1cywgZXZlbnRzfSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0dXMuaXNJbkJsb2NrKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCh7ZXZlbnQ6IHtkYXRhLCBtZXRob2R9fSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PSAnQ3JlYXRlQ29sbGVjdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxDb2xsZWN0aW9uSWQgPSBkYXRhWzBdLnRvTnVtYmVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFwaS50eC5uZnQubWludChnbG9iYWxDb2xsZWN0aW9uSWQsIHF1YW50aXR5LCB0b2tlbk93bmVyLmFkZHJlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2lnbkFuZFNlbmQoY29sbGVjdGlvbk93bmVyLCB7bm9uY2U6IC0xfSwgYXN5bmMgKHtzdGF0dXMsIGV2ZW50c30pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzLmlzSW5CbG9jaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHMuZm9yRWFjaCgoe2V2ZW50OiB7ZGF0YSwgbWV0aG9kfX0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT0gJ01pbnQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbklkID0gZGF0YVswXS50b051bWJlcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNlcmllc0lkID0gZGF0YVsxXS50b051bWJlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbFRva2VuSWRzID0gZ2xvYmFsVG9rZW5JZHMubWFwKChfLCBzZXJpYWxOdW1iZXIpID0+IFtjb2xsZWN0aW9uSWQsIHNlcmllc0lkLCBzZXJpYWxOdW1iZXJdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgICBpdCgnY3JlYXRlcyBhIGNvbGxlY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb25OYW1lID0gJ2V4YW1wbGUtY29sbGVjdGlvbic7XG4gICAgICAgICAgICAgIGNvbnN0IHF1YW50aXR5ID0gMztcbiAgICAgICAgICAgICAgY29uc3QgbWF4SXNzdWFuY2UgPSBudWxsO1xuICAgICAgICAgICAgICBjb25zdCB0b2tlbk93bmVyID0gbnVsbDtcbiAgICAgICAgICAgICAgY29uc3Qgcm95YWx0eSA9IG51bGw7XG4gICAgICAgICAgICAgIGNvbnN0IGNyb3NzQ2hhaW5Db21wYXRpYmlsaXR5ID0ge1wieHJwbFwiOiBmYWxzZX07XG4gICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhU2NoZW1hID0gXCJodHRwOi8vZXhhbXBsZS5jb20vbmZ0L21ldGFkYXRhXCI7XG4gICAgICAgICAgICBhd2FpdCBhcGkudHgubmZ0LmNyZWF0ZUNvbGxlY3Rpb24oXG4gICAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lLCBxdWFudGl0eSxcbiAgICAgICAgICAgICAgICBtYXhJc3N1YW5jZSwgdG9rZW5Pd25lciwgbWV0YWRhdGFTY2hlbWEsIHJveWFsdHksIGNyb3NzQ2hhaW5Db21wYXRpYmlsaXR5XG4gICAgICAgICAgICApLnNpZ25BbmRTZW5kKGNvbGxlY3Rpb25Pd25lciwge25vbmNlOiAtMX0sYXN5bmMgKHsgc3RhdHVzLCBldmVudHMgfSkgPT4ge1xuICAgICAgICAgICAgICBpZiAoc3RhdHVzLmlzSW5CbG9jaykge1xuICAgICAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCh7cGhhc2UsIGV2ZW50OiB7ZGF0YSwgbWV0aG9kLCBzZWN0aW9ufX0pID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXHQnLCBwaGFzZS50b1N0cmluZygpLCBgOiAke3NlY3Rpb259LiR7bWV0aG9kfWAsIGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgICBpZiAobWV0aG9kID09ICdDcmVhdGVDb2xsZWN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uSWQgPSBkYXRhWzBdLnRvTnVtYmVyKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBnb3QgY29sbGVjdGlvbjogJHtjb2xsZWN0aW9uSWR9YCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IGFwaS5xdWVyeS5uZnQuY29sbGVjdGlvbkluZm8oY29sbGVjdGlvbklkKTtcbiAgICAgICAgICAgICAgICBleHBlY3QoaW5mby5vd25lcikudG9CZShjb2xsZWN0aW9uT3duZXIuYWRkcmVzcyk7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGluZm8ubmFtZSkudG9CZShzdHJpbmdUb0hleChjb2xsZWN0aW9uTmFtZSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcblxuXG5cbiAgaXQoJ2J1cm4gc2Vjb25kIHRva2VuIGZyb20gc2VyaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNlcmlhbE51bWJlciA9IDE7XG4gICAgY29uc3QgdG9rZW5JZCA9IFtnbG9iYWxDb2xsZWN0aW9uSWQsIHNlcmlhbE51bWJlcl07XG4gICAgLy8gYXBpLnJlZ2lzdHJ5LmNyZWF0ZVR5cGUoJ1Rva2VuSWQnLCB0b2tlbklkKTtcbiAgICBhd2FpdCBhcGkudHgubmZ0LmJ1cm4odG9rZW5JZClcbiAgICAgIC5zaWduQW5kU2VuZCh0b2tlbk93bmVyLCB7bm9uY2U6IC0xfSwgYXN5bmMgKHsgc3RhdHVzLCBldmVudHMgfSkgPT4ge1xuICAgICAgICBpZiAoc3RhdHVzLmlzSW5CbG9jaykge1xuICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKCh7ZXZlbnQ6IHtkYXRhLCBtZXRob2R9fSkgPT4ge1xuICAgICAgICAgICAgaWYgKG1ldGhvZCA9PSAnQnVybicpIHtcbiAgICAgICAgICAgICAgY29uc3QgW2NvbGxJZCwgc2VyaWFsTm8gXSA9IGRhdGE7XG4gICAgICAgICAgICAgIGV4cGVjdChjb2xsSWQudG9OdW1iZXIoKSkudG9FcXVhbChnbG9iYWxDb2xsZWN0aW9uSWQpO1xuICAgICAgICAgICAgICBleHBlY3Qoc2VyaWFsTm8udG9OdW1iZXIoKSkudG9FcXVhbChzZXJpYWxOdW1iZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ2ZpbmRzIGNvbGxlY3RlZCB0b2tlbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgIGNvbnN0IGN1cnNvciA9IDA7XG4gICAgIGNvbnN0IGxpbWl0ID0gNTtcbiAgICBjb25zdCBvd25lZFRva2VucyA9IChhd2FpdCBhcGkucnBjLm5mdC5vd25lZFRva2VucyhnbG9iYWxDb2xsZWN0aW9uSWQsIGNvbGxlY3Rpb25Pd25lci5hZGRyZXNzLCBjdXJzb3IgLCBsaW1pdCkpO1xuICAgIGV4cGVjdChvd25lZFRva2Vuc1syXSkudG9FcXVhbChbMCwgMSwgMl0pO1xuICB9KTtcbn0pO1xuXG4gICAgLy8vIFRPRE8gLSBhZGQgbW9yZSB0ZXN0IGZvciBsaXN0aW5nIGJ1eS9zZWxsXG59KTtcblxuIl0sInZlcnNpb24iOjN9